# 币安对冲网格自动化交易系统

基于Python的币安现货对冲网格策略交易程序，使用真实API连接币安交易所。

## 功能特性

### 核心功能
- ✅ 对冲网格策略：多空双向网格，自动对冲持仓
- ✅ 真实API连接：使用CCXT库连接币安真实交易API
- ✅ 交互式配置：命令行引导式配置参数
- ✅ 自动网格管理：自动下单、撤单、补单
- ✅ 实时监控：终端实时输出交易状态
- ✅ 测试网络支持：支持币安测试网络

### 新增功能
- ✅ **风险控制系统**：止损、持仓限制、每日亏损上限
- ✅ **交易记录持久化**：自动记录每笔交易，支持历史查询
- ✅ **统计分析工具**：详细的交易数据和盈亏分析
- ✅ **异常恢复机制**：自动重试和订单状态同步
- ✅ **日志系统优化**：支持日志轮转，格式化输出
- ✅ **配置验证增强**：自动验证配置参数，减少错误

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行程序

```bash
python src/main.py
```

或使用启动脚本：

```bash
bash start.sh
```

首次运行会进入配置向导，按照提示输入：
- 币安 API Key 和 Secret
- 交易对（如 BTC/USDT）
- 网格参数（数量、间距、投资金额等）

### 3. 测试连接（可选）

在启动策略前，建议先测试连接：

```bash
# 基础功能测试（无需API）
python3 test_connection.py

# 完整测试（需要配置真实API）
python3 test_balance.py
```

### 4. 启动策略

配置完成后，确认启动，策略会自动：
- 连接币安交易所
- 放置网格订单
- 监控成交并自动对冲

## 项目结构

```
.
├── src/
│   ├── exchanges/          # 交易所模块
│   │   └── binance_exchange.py
│   ├── strategies/         # 策略模块
│   │   └── hedge_grid_strategy.py
│   ├── interactive/        # 交互式配置
│   │   └── config_interactive.py
│   ├── config/             # 配置管理
│   │   └── config_manager.py
│   ├── storage/            # 数据存储（新增）
│   │   └── trade_recorder.py
│   ├── utils/              # 工具模块（新增）
│   │   └── logger.py
│   └── main.py             # 主入口
├── config/
│   └── config.json         # 配置文件
├── data/                   # 数据目录（新增）
│   ├── trades.jsonl        # 交易记录
│   └── stats.json          # 统计数据
├── logs/                   # 日志目录
├── requirements.txt        # 依赖包
├── analyze_trades.py       # 统计分析工具（新增）
├── test_connection.py      # 测试脚本
├── test_balance.py         # 余额测试
└── test_complete_features.py # 完整功能测试（新增）
```

## 策略说明

### 对冲网格原理

1. **网格布局**：在基准价格上下设置多档位网格
2. **双向对冲**：
   - 下方网格：挂买单，价格下跌时买入
   - 上方网格：挂卖单，价格上涨时卖出
3. **自动对冲**：
   - 买单成交后，在上方放置对冲卖单
   - 卖单成交后，在下方放置对冲买单

### 参数说明

**基础参数：**
- **交易对**：如 BTC/USDT
- **基准价格**：网格中心价格（留空使用当前价格）
- **网格数量**：网格档位数量（建议5-20）
- **网格间距**：网格间距百分比（如1%）
- **投资金额**：投入的USDT金额
- **最小止盈**：单笔最小盈利百分比

**风险控制参数（新增）：**
- **止损百分比**：价格跌破基准价的多少时止损（默认5%）
- **最大持仓**：最大持仓数量（0表示不限制）
- **每日最大亏损**：单日最大亏损金额USDT（默认100）
- **每日最大交易次数**：单日最大交易次数（默认100）

详细说明请查看：[IMPROVEMENTS.md](IMPROVEMENTS.md)

## 注意事项

⚠️ **重要提示**：

1. 本程序使用真实API，操作真实资金，请谨慎使用
2. 首次使用建议先用测试网络（testnet）
3. 确保账户有足够余额
4. 策略运行时请保持网络连接稳定
5. 生产环境使用前请充分测试
6. 作者不对交易损失负责

## 配置币安API

1. 登录币安账户
2. 进入 API管理页面
3. 创建新API密钥
4. 权限选择：现货交易
5. 建议绑定IP白名单

## 测试工具

### 测试脚本说明

项目提供了两个测试脚本：

**test_connection.py** - 基础功能测试
- 测试模块导入
- 测试配置管理
- 测试交易所实例创建
- 无需真实API即可运行

**test_balance.py** - 完整连接测试
- 测试币安API连接
- 获取账户余额
- 获取市场行情
- 需要配置真实的API Key

## 常见问题

### Q: 如何使用测试网络？

A: 配置时选择 "y" 使用测试网络。币安测试网地址：https://testnet.binance.vision/

### Q: 如何测试连接是否正常？

A: 运行测试脚本：`python3 test_balance.py`

### Q: 如何停止策略？

A: 按 `Ctrl+C` 停止策略，会自动撤销所有挂单

### Q: 如何修改配置？

A: 编辑 `config/config.json` 文件，或重新运行程序重新配置

### Q: 如何查看日志？

A: 日志保存在 `logs/trading.log` 文件中

## 技术栈

- Python 3.12+
- CCXT - 加密货币交易库
- asyncio - 异步编程
- pydantic - 数据验证

## License

MIT License
