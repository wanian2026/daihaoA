<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸å®‰åŒå‘æŒä»“ç­–ç•¥ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .status-running { color: #10b981; }
        .status-paused { color: #f59e0b; }
        .status-stopped { color: #ef4444; }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">å¸å®‰åŒå‘æŒä»“ç­–ç•¥ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="text-white/80">å®æ—¶ç›‘æ§ Â· æ‰‹åŠ¨å¹²é¢„ Â· æ•°æ®åˆ†æ</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šç­–ç•¥çŠ¶æ€ -->
            <div class="lg:col-span-2 space-y-6">
                <!-- ç­–ç•¥çŠ¶æ€å¡ç‰‡ -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ“Š</span> ç­–ç•¥çŠ¶æ€
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">å½“å‰ä»·æ ¼</div>
                            <div class="text-2xl font-bold text-blue-600" id="current-price">--</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">ATRå€¼</div>
                            <div class="text-2xl font-bold text-green-600" id="current-atr">--</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">å¤šå•æ•°é‡</div>
                            <div class="text-2xl font-bold text-purple-600" id="long-count">--</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">ç©ºå•æ•°é‡</div>
                            <div class="text-2xl font-bold text-orange-600" id="short-count">--</div>
                        </div>
                    </div>

                    <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">å¤šå•æµ®ç›ˆ</div>
                            <div class="text-xl font-bold" id="long-pnl">--</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">ç©ºå•æµ®ç›ˆ</div>
                            <div class="text-xl font-bold" id="short-pnl">--</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 col-span-2 md:col-span-1">
                            <div class="text-sm text-gray-600 mb-1">æ€»æµ®ç›ˆ</div>
                            <div class="text-xl font-bold" id="total-pnl">--</div>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">ç­–ç•¥è¿è¡ŒçŠ¶æ€ï¼š</span>
                            <span class="text-lg font-bold" id="is-running">--</span>
                        </div>
                    </div>
                </div>

                <!-- æŒä»“åˆ—è¡¨ -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ’¼</span> æŒä»“è¯¦æƒ…
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-2 px-3">ç±»å‹</th>
                                    <th class="text-left py-2 px-3">å…¥åœºä»·æ ¼</th>
                                    <th class="text-left py-2 px-3">æ•°é‡</th>
                                    <th class="text-left py-2 px-3">æ­¢ç›ˆä»·æ ¼</th>
                                    <th class="text-left py-2 px-3">æ­¢æŸä»·æ ¼</th>
                                    <th class="text-left py-2 px-3">æµ®ç›ˆ</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- äº¤æ˜“å†å² -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ“ˆ</span> äº¤æ˜“å†å²
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-2 px-3">æ—¶é—´</th>
                                    <th class="text-left py-2 px-3">ç±»å‹</th>
                                    <th class="text-left py-2 px-3">å…¥åœº</th>
                                    <th class="text-left py-2 px-3">å¹³ä»“</th>
                                    <th class="text-left py-2 px-3">ç›ˆäº</th>
                                    <th class="text-left py-2 px-3">åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="trades-table">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å®æ—¶æ—¥å¿— -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ“</span> å®æ—¶æ—¥å¿—
                        <button onclick="clearLogs()" class="ml-auto text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">
                            æ¸…ç©ºæ—¥å¿—
                        </button>
                    </h2>
                    <div class="log-container bg-gray-900 text-green-400 p-4 rounded-lg" id="log-container">
                        <div class="log-entry">ç­‰å¾…è¿æ¥...</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ“ä½œé¢æ¿ -->
            <div class="space-y-6">
                <!-- æ‰‹åŠ¨æ“ä½œ -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ®</span> æ‰‹åŠ¨æ“ä½œ
                    </h2>
                    <div class="space-y-3">
                        <button onclick="manualLong()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition">
                            æ‰‹åŠ¨å¼€å¤š
                        </button>
                        <button onclick="manualShort()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition">
                            æ‰‹åŠ¨å¼€ç©º
                        </button>
                        <button onclick="closeAll()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg transition">
                            å¹³ä»“æ‰€æœ‰æŒä»“
                        </button>
                    </div>
                </div>

                <!-- ç­–ç•¥æ§åˆ¶ -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">âš™ï¸</span> ç­–ç•¥æ§åˆ¶
                    </h2>
                    <div class="space-y-3">
                        <button onclick="pauseStrategy()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition">
                            æš‚åœç­–ç•¥
                        </button>
                        <button onclick="resumeStrategy()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">
                            æ¢å¤ç­–ç•¥
                        </button>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ“Š</span> äº¤æ˜“ç»Ÿè®¡
                    </h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">æ€»äº¤æ˜“æ¬¡æ•°</span>
                            <span class="font-bold" id="total-trades">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">å¤šå•ç›ˆåˆ©</span>
                            <span class="font-bold text-green-600" id="long-profit-count">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">å¤šå•äºæŸ</span>
                            <span class="font-bold text-red-600" id="long-loss-count">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ç©ºå•ç›ˆåˆ©</span>
                            <span class="font-bold text-green-600" id="short-profit-count">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ç©ºå•äºæŸ</span>
                            <span class="font-bold text-red-600" id="short-loss-count">--</span>
                        </div>
                        <div class="flex justify-between border-t pt-3">
                            <span class="text-gray-600">æ€»ç›ˆåˆ©</span>
                            <span class="font-bold text-green-600" id="total-profit">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">æ€»äºæŸ</span>
                            <span class="font-bold text-red-600" id="total-loss">--</span>
                        </div>
                        <div class="flex justify-between border-t pt-3">
                            <span class="text-gray-600 font-bold">å‡€ç›ˆåˆ©</span>
                            <span class="font-bold text-lg" id="net-profit">--</span>
                        </div>
                    </div>
                </div>

                <!-- æ¯æ—¥ç»Ÿè®¡ -->
                <div class="card rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ“…</span> æ¯æ—¥ç»Ÿè®¡
                    </h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">ä»Šæ—¥äºæŸ</span>
                            <span class="font-bold" id="daily-loss">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ä»Šæ—¥äº¤æ˜“æ¬¡æ•°</span>
                            <span class="font-bold" id="daily-trades">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let reconnectTimer = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                addLog('WebSocketè¿æ¥æˆåŠŸ', 'info');
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                addLog('WebSocketé”™è¯¯', 'error');
            };

            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å…³é—­');
                addLog('WebSocketè¿æ¥å…³é—­ï¼Œ5ç§’åé‡è¿...', 'warning');
                reconnectTimer = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(message) {
            switch(message.type) {
                case 'status_update':
                    updateStatus(message.data);
                    break;
                case 'trade_update':
                    addTrade(message.data);
                    break;
                case 'log_update':
                    addLog(message.data.message, message.data.level);
                    break;
            }
        }

        function updateStatus(status) {
            // æ›´æ–°ä»·æ ¼
            document.getElementById('current-price').textContent = status.current_price.toFixed(2);
            document.getElementById('current-atr').textContent = status.current_atr.toFixed(4);

            // æ›´æ–°æŒä»“æ•°é‡
            document.getElementById('long-count').textContent = status.positions.long_count;
            document.getElementById('short-count').textContent = status.positions.short_count;

            // æ›´æ–°æµ®ç›ˆ
            const longPnl = status.positions.long_pnl;
            const shortPnl = status.positions.short_pnl;
            const totalPnl = status.positions.total_pnl;

            document.getElementById('long-pnl').textContent = formatPnl(longPnl);
            document.getElementById('short-pnl').textContent = formatPnl(shortPnl);
            document.getElementById('total-pnl').textContent = formatPnl(totalPnl);

            // æ›´æ–°è¿è¡ŒçŠ¶æ€
            const isRunning = status.is_running;
            const isPaused = status.daily.is_paused;
            const statusEl = document.getElementById('is-running');

            if (!isRunning) {
                statusEl.textContent = 'å·²åœæ­¢';
                statusEl.className = 'text-lg font-bold status-stopped';
            } else if (isPaused) {
                statusEl.textContent = 'å·²æš‚åœ';
                statusEl.className = 'text-lg font-bold status-paused';
            } else {
                statusEl.textContent = 'è¿è¡Œä¸­';
                statusEl.className = 'text-lg font-bold status-running';
            }

            // æ›´æ–°ç»Ÿè®¡
            const stats = status.stats;
            document.getElementById('total-trades').textContent = stats.total_trades;
            document.getElementById('long-profit-count').textContent = stats.long_profit_count;
            document.getElementById('long-loss-count').textContent = stats.long_loss_count;
            document.getElementById('short-profit-count').textContent = stats.short_profit_count;
            document.getElementById('short-loss-count').textContent = stats.short_loss_count;
            document.getElementById('total-profit').textContent = stats.total_profit.toFixed(2) + ' USDT';
            document.getElementById('total-loss').textContent = stats.total_loss.toFixed(2) + ' USDT';
            document.getElementById('net-profit').textContent = formatPnl(stats.net_profit);

            // æ›´æ–°æ¯æ—¥ç»Ÿè®¡
            const daily = status.daily;
            document.getElementById('daily-loss').textContent = daily.daily_loss.toFixed(2) + ' USDT';
            document.getElementById('daily-trades').textContent = daily.daily_trades;

            // æ›´æ–°æŒä»“åˆ—è¡¨
            updatePositions();
        }

        function formatPnl(value) {
            const color = value >= 0 ? 'text-green-600' : 'text-red-600';
            const sign = value >= 0 ? '+' : '';
            return `<span class="${color}">${sign}${value.toFixed(2)} USDT</span>`;
        }

        function formatPrice(value) {
            return value.toFixed(2);
        }

        async function updatePositions() {
            try {
                const response = await fetch('/api/positions');
                const result = await response.json();
                const positions = result.data;

                const tableBody = document.getElementById('positions-table');
                tableBody.innerHTML = '';

                if (positions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">æš‚æ— æŒä»“</td></tr>';
                    return;
                }

                positions.forEach(pos => {
                    const type = pos.type === 'long' ? 'å¤šå•' : 'ç©ºå•';
                    const typeColor = pos.type === 'long' ? 'text-green-600' : 'text-red-600';
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-2 px-3 ${typeColor}">${type}</td>
                        <td class="py-2 px-3">${formatPrice(pos.entry_price)}</td>
                        <td class="py-2 px-3">${pos.amount.toFixed(6)}</td>
                        <td class="py-2 px-3">--</td>
                        <td class="py-2 px-3">--</td>
                        <td class="py-2 px-3">--</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('æ›´æ–°æŒä»“åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function loadTrades() {
            try {
                const response = await fetch('/api/trades?limit=50');
                const result = await response.json();
                const trades = result.data;

                const tableBody = document.getElementById('trades-table');
                tableBody.innerHTML = '';

                if (trades.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
                    return;
                }

                trades.forEach(trade => {
                    const type = trade.type === 'long' ? 'å¤šå•' : 'ç©ºå•';
                    const typeColor = trade.type === 'long' ? 'text-green-600' : 'text-red-600';
                    const pnlColor = trade.profit >= 0 ? 'text-green-600' : 'text-red-600';
                    const pnlSign = trade.profit >= 0 ? '+' : '';

                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-2 px-3">${new Date(trade.timestamp * 1000).toLocaleString('zh-CN')}</td>
                        <td class="py-2 px-3 ${typeColor}">${type}</td>
                        <td class="py-2 px-3">${formatPrice(trade.entry_price)}</td>
                        <td class="py-2 px-3">${formatPrice(trade.exit_price)}</td>
                        <td class="py-2 px-3 ${pnlColor}">${pnlSign}${trade.profit.toFixed(2)}</td>
                        <td class="py-2 px-3">${trade.reason}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('åŠ è½½äº¤æ˜“å†å²å¤±è´¥:', error);
            }
        }

        function addTrade(trade) {
            // æ·»åŠ æ–°äº¤æ˜“åˆ°è¡¨æ ¼é¡¶éƒ¨
            const tableBody = document.getElementById('trades-table');

            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ•°æ®ï¼Œæ¸…ç©º"åŠ è½½ä¸­"
            if (tableBody.querySelector('td')?.textContent === 'åŠ è½½ä¸­...') {
                tableBody.innerHTML = '';
            }

            const type = trade.type === 'long' ? 'å¤šå•' : 'ç©ºå•';
            const typeColor = trade.type === 'long' ? 'text-green-600' : 'text-red-600';
            const pnlColor = trade.profit >= 0 ? 'text-green-600' : 'text-red-600';
            const pnlSign = trade.profit >= 0 ? '+' : '';

            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50 bg-green-50';
            row.innerHTML = `
                <td class="py-2 px-3">${new Date(trade.timestamp * 1000).toLocaleString('zh-CN')}</td>
                <td class="py-2 px-3 ${typeColor}">${type}</td>
                <td class="py-2 px-3">${formatPrice(trade.entry_price)}</td>
                <td class="py-2 px-3">${formatPrice(trade.exit_price)}</td>
                <td class="py-2 px-3 ${pnlColor}">${pnlSign}${trade.profit.toFixed(2)}</td>
                <td class="py-2 px-3">${trade.reason}</td>
            `;

            tableBody.insertBefore(row, tableBody.firstChild);

            // ä¿æŒæœ€å¤š50æ¡è®°å½•
            while (tableBody.children.length > 50) {
                tableBody.removeChild(tableBody.lastChild);
            }
        }

        function addLog(message, level = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString('zh-CN');

            const levelColors = {
                'info': 'text-blue-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400',
                'success': 'text-green-400'
            };

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="${levelColors[level]}">[${level.toUpperCase()}]</span> ${message}`;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // ä¿æŒæœ€å¤š500æ¡æ—¥å¿—
            while (logContainer.children.length > 500) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function clearLogs() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // APIè°ƒç”¨å‡½æ•°
        async function apiCall(url, method = 'POST', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(url, options);
                const result = await response.json();

                if (result.success) {
                    addLog(result.message, 'success');
                    return result;
                } else {
                    addLog(result.message || 'æ“ä½œå¤±è´¥', 'error');
                    throw new Error(result.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                addLog(error.message, 'error');
                throw error;
            }
        }

        async function manualLong() {
            await apiCall('/api/manual/long');
        }

        async function manualShort() {
            await apiCall('/api/manual/short');
        }

        async function closeAll() {
            if (confirm('ç¡®å®šè¦å¹³ä»“æ‰€æœ‰æŒä»“å—ï¼Ÿ')) {
                await apiCall('/api/close/all');
            }
        }

        async function pauseStrategy() {
            await apiCall('/api/pause');
        }

        async function resumeStrategy() {
            await apiCall('/api/resume');
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            connectWebSocket();
            loadTrades();
            addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
        };
    </script>
</body>
</html>
